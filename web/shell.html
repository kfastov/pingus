<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pingus Web</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="topbar">
        <div class="title">
          <div class="kicker">GPL Source Port</div>
          <h1>Pingus Web</h1>
          <p>
            Official Pingus sources compiled to WebAssembly. First load takes a minute
            while the assets are cached.
          </p>
        </div>
        <div class="status-card">
          <div id="status">Preparing...</div>
          <progress id="progress" value="0" max="100" hidden></progress>
          <div id="spinner" class="spinner" aria-hidden="true"></div>
        </div>
      </header>

      <main class="stage">
        <div class="canvas-frame">
          <canvas id="canvas" tabindex="-1"></canvas>
        </div>
        <div class="controls">
          <button id="fullscreen">Fullscreen</button>
          <button id="reload">Reload</button>
        </div>
      </main>
    </div>

    <script>
      var statusElement = document.getElementById("status");
      var progressElement = document.getElementById("progress");
      var spinnerElement = document.getElementById("spinner");
      var Module = {
        preRun: [],
        postRun: [],
        print: (function() {
          return function(text) {
            if (text) {
              console.log(text);
            }
            if (statusElement) {
              statusElement.textContent = text;
            }
          };
        })(),
        printErr: function(text) {
          if (text) {
            console.error(text);
          }
        },
        canvas: (function() {
          var canvas = document.getElementById("canvas");
          canvas.addEventListener("webglcontextlost", function(event) {
            event.preventDefault();
            statusElement.textContent = "WebGL context lost. Reload the page.";
          }, false);
          return canvas;
        })(),
        setStatus: function(text) {
          if (!statusElement) {
            return;
          }
          if (!Module.setStatus.last) {
            Module.setStatus.last = { time: Date.now(), text: "" };
          }
          if (text === Module.setStatus.last.text) {
            return;
          }
          var match = text.match(/\((\d+(?:\.\d+)?)\/(\d+(?:\.\d+)?)\)/);
          if (match) {
            progressElement.hidden = false;
            spinnerElement.hidden = false;
            progressElement.value = parseFloat(match[1]) * 100;
            progressElement.max = parseFloat(match[2]) * 100;
            statusElement.textContent = text.replace(match[0], "");
          } else {
            progressElement.hidden = true;
            spinnerElement.hidden = true;
            statusElement.textContent = text;
          }
          Module.setStatus.last.text = text;
        },
        monitorRunDependencies: function(left) {
          Module.totalDependencies = Math.max(Module.totalDependencies || 0, left);
          Module.setStatus(left ? "Downloading assets... (" + (Module.totalDependencies - left) + "/" + Module.totalDependencies + ")" : "Ready");
        }
      };

      function initIdbfs() {
        var idbfs = (typeof IDBFS !== "undefined") ? IDBFS : (Module && Module.IDBFS);
        if (typeof FS === "undefined" || !idbfs) {
          console.warn("IDBFS unavailable");
          return;
        }

        var userDir = "/home/web_user/.pingus";
        var ensureDir = function(path) {
          try {
            FS.mkdir(path);
          } catch (e) {
          }
        };

        ensureDir("/home");
        ensureDir("/home/web_user");
        ensureDir(userDir);

        try {
          FS.mount(idbfs, {}, userDir);
        } catch (e) {
          console.warn("IDBFS mount failed", e);
          return;
        }

        var syncInFlight = false;
        Module._pingusSyncfs = function(populate, reason) {
          if (syncInFlight) {
            return;
          }
          syncInFlight = true;
          FS.syncfs(!!populate, function(err) {
            syncInFlight = false;
            if (err) {
              console.error("[idbfs]", reason || "sync", err);
            }
          });
        };

        Module._pingusSyncfs(true, "populate");
      }

      Module.preRun.push(initIdbfs);
      Module.postRun.push(function() {
        setupResponsiveCanvas();
      });

      function schedulePersist(reason) {
        if (Module._pingusSyncfs) {
          Module._pingusSyncfs(false, reason);
        }
      }

      window.addEventListener("visibilitychange", function() {
        if (document.visibilityState === "hidden") {
          schedulePersist("visibility");
        }
      });
      window.addEventListener("beforeunload", function() {
        schedulePersist("unload");
      });

      window.onerror = function() {
        Module.setStatus("Exception thrown, see console");
        spinnerElement.hidden = true;
      };

      function setupResponsiveCanvas() {
        var frame = document.querySelector(".canvas-frame");
        var stage = document.querySelector(".stage");
        var controls = document.querySelector(".controls");
        var canvas = Module.canvas || document.getElementById("canvas");
        var lastSize = null;
        var fullscreenWatchActive = false;
        var fullscreenLastSize = null;
        if (!frame) {
          return;
        }

        var pending = false;
        function schedule() {
          if (pending) {
            return;
          }
          pending = true;
          requestAnimationFrame(function() {
            pending = false;
            updateCanvasSize();
          });
        }

        function getViewportBox() {
          if (window.visualViewport) {
            return {
              width: window.visualViewport.width,
              height: window.visualViewport.height,
              top: window.visualViewport.offsetTop,
              left: window.visualViewport.offsetLeft
            };
          }
          return {
            width: document.documentElement.clientWidth,
            height: document.documentElement.clientHeight,
            top: 0,
            left: 0
          };
        }

        function applyCanvasSize(width, height) {
          frame.style.width = width + "px";
          frame.style.height = height + "px";
          if (!canvas) {
            return;
          }
          canvas.style.setProperty("width", width + "px", "important");
          canvas.style.setProperty("height", height + "px", "important");
        }

        function applyCanvasSizeDeferred(width, height) {
          lastSize = { width: width, height: height };
          applyCanvasSize(width, height);
          requestAnimationFrame(function() {
            applyCanvasSize(width, height);
          });
        }

        function startFullscreenWatch() {
          if (fullscreenWatchActive) {
            return;
          }
          fullscreenWatchActive = true;
          requestAnimationFrame(watchFullscreen);
        }

        function watchFullscreen() {
          if (!document.fullscreenElement) {
            fullscreenWatchActive = false;
            fullscreenLastSize = null;
            return;
          }
          var viewport = getViewportBox();
          var watchWidth = Math.max(1, Math.floor(viewport.width));
          var watchHeight = Math.max(1, Math.floor(viewport.height));
          if (!fullscreenLastSize ||
              fullscreenLastSize.width !== watchWidth ||
              fullscreenLastSize.height !== watchHeight) {
            fullscreenLastSize = { width: watchWidth, height: watchHeight };
            updateCanvasSize();
          }
          requestAnimationFrame(watchFullscreen);
        }

        function updateCanvasSize() {
          if (!Module || !Module._pingus_set_window_size || !canvas) {
            return;
          }

          if (document.fullscreenElement) {
            var viewport = getViewportBox();
            var fullWidth = Math.max(1, Math.floor(viewport.width));
            var fullHeight = Math.max(1, Math.floor(viewport.height));
            Module._pingus_set_window_size(fullWidth, fullHeight);
            if (typeof Browser !== "undefined" && Browser.setCanvasSize) {
              var dpr = window.devicePixelRatio || 1;
              var pixelWidth = Math.max(1, Math.floor(fullWidth * dpr));
              var pixelHeight = Math.max(1, Math.floor(fullHeight * dpr));
              Browser.setCanvasSize(pixelWidth, pixelHeight, true);
            }
            applyCanvasSizeDeferred(fullWidth, fullHeight);
            startFullscreenWatch();
            return;
          }

          var frameRect = frame.getBoundingClientRect();
          var availableWidth = frameRect.width;
          var availableHeight = 0;
          if (stage) {
            var stageStyle = getComputedStyle(stage);
            var paddingX = (parseFloat(stageStyle.paddingLeft) || 0) + (parseFloat(stageStyle.paddingRight) || 0);
            var paddingY = (parseFloat(stageStyle.paddingTop) || 0) + (parseFloat(stageStyle.paddingBottom) || 0);
            availableWidth = Math.max(0, stage.clientWidth - paddingX);
            availableHeight = Math.max(0, stage.clientHeight - paddingY);
          }
          var viewportBox = getViewportBox();

          if (controls) {
            var controlsRect = controls.getBoundingClientRect();
            var controlsStyle = getComputedStyle(controls);
            var marginTop = parseFloat(controlsStyle.marginTop) || 0;
            availableHeight = Math.max(0, controlsRect.top - frameRect.top - marginTop);
          } else {
            availableHeight = Math.max(0, viewportBox.top + viewportBox.height - frameRect.top);
          }

          var targetWidth = Math.max(1, Math.floor(availableWidth));
          var targetHeight = Math.max(1, Math.floor(targetWidth * 3 / 4));
          if (availableHeight > 0 && targetHeight > availableHeight) {
            targetHeight = Math.floor(availableHeight);
            targetWidth = Math.floor(targetHeight * 4 / 3);
          }

          Module._pingus_set_window_size(targetWidth, targetHeight);
          applyCanvasSizeDeferred(targetWidth, targetHeight);
        }

        if (canvas && typeof MutationObserver !== "undefined") {
          var styleObserver = new MutationObserver(function() {
            if (!lastSize) {
              return;
            }
            var desiredWidth = lastSize.width + "px";
            var desiredHeight = lastSize.height + "px";
            if (canvas.style.width === desiredWidth && canvas.style.height === desiredHeight) {
              return;
            }
            applyCanvasSize(lastSize.width, lastSize.height);
          });
          styleObserver.observe(canvas, { attributes: true, attributeFilter: ["style"] });
        }
        if (typeof ResizeObserver !== "undefined") {
          var viewportObserver = new ResizeObserver(function() {
            schedule();
          });
          viewportObserver.observe(document.documentElement);
        }

        schedule();
        window.addEventListener("resize", schedule);
        window.addEventListener("orientationchange", schedule);
        document.addEventListener("fullscreenchange", schedule);
        if (window.visualViewport) {
          window.visualViewport.addEventListener("resize", schedule);
        }
      }

      var fullscreenButton = document.getElementById("fullscreen");
      if (fullscreenButton) {
        fullscreenButton.addEventListener("click", function() {
          if (Module && Module._pingus_toggle_fullscreen) {
            Module._pingus_toggle_fullscreen();
          }
        });
      }
      document.getElementById("reload").addEventListener("click", function() {
        window.location.reload();
      });
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
